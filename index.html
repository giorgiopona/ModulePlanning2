<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
      :root {
        --primary-color: #10AD8E;
        --primary-light: #4DBFA8;
        --primary-dark: #0A8A73;
        --accent-color: #E6F7F3;
        --accent-dark: #B3E6D9;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        color: #333;
        overflow-x: hidden;
      }
      .wrapper {
        display: flex;
        width: 100%;
        align-items: stretch;
      }
      #sidebar {
        min-width: 240px;
        max-width: 240px;
        background-color: white;
        border-right: 1px solid var(--accent-dark);
        transition: all 0.3s;
        height: 100vh;
      }
      #sidebar.toggled {
        margin-left: -240px;
      }
      #sidebar .logo {
        font-weight: bold;
        font-size: 1.2rem;
        margin-bottom: 20px;
        padding: 20px;
        color: var(--primary-color);
      }
      #sidebar .nav-link {
        color: #333;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 5px;
        transition: all 0.3s ease;
      }
      #sidebar .nav-link:hover {
        background-color: var(--accent-color);
        color: var(--primary-color);
      }
      #sidebar .nav-link.active {
        background-color: var(--primary-color);
        font-weight: bold;
        color: white;
      }
      .main-content {
        flex-grow: 1;
        padding: 30px;
        background-color: #fff;
        width: 100%;
        overflow-y: auto;
      }
      .main-content h1 {
        font-size: 1.8rem;
        font-weight: 400;
        margin-bottom: 30px;
        color: var(--primary-color);
      }
      .card {
        border: 1px solid var(--accent-dark);
        box-shadow: 0 2px 4px rgba(16, 173, 142, 0.1);
        margin-bottom: 20px;
      }
      .card-title {
        color: var(--primary-color);
        font-weight: 600;
      }
      .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }
      .btn-primary:hover {
        background-color: var(--primary-dark);
        border-color: var(--primary-dark);
      }
      .btn-secondary {
        background-color: var(--primary-light);
        border-color: var(--primary-light);
        color: white;
      }
      .btn-secondary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
      }
      #sidebar-toggle {
        display: none;
      }
      .module-card {
        border-left: 4px solid var(--primary-color);
        transition: all 0.3s ease;
      }
      .module-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(16, 173, 142, 0.2);
      }
      .module-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        padding: 15px;
        border-radius: 5px 5px 0 0;
      }
      .module-stats {
        display: flex;
        justify-content: space-around;
        padding: 15px;
        background-color: var(--accent-color);
      }
      .stat-item {
        text-align: center;
      }
      .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
      }
      .stat-label {
        font-size: 0.8rem;
        color: #666;
        text-transform: uppercase;
      }
      .timetable-table {
        table-layout: fixed;
        width: 100%;
      }
      .timetable-table th,
      .timetable-table td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: var(--primary-color);
      }
      .error {
        color: #dc3545;
        padding: 20px;
        text-align: center;
      }
      .module-selector {
        margin-bottom: 30px;
      }
      .module-badge {
        background-color: var(--accent-color);
        color: var(--primary-color);
        padding: 5px 10px;
        border-radius: 15px;
        margin: 2px;
        display: inline-block;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .module-badge:hover {
        background-color: var(--primary-color);
        color: white;
      }
      .module-badge.active {
        background-color: var(--primary-color);
        color: white;
      }
      
      .group-content {
        transition: all 0.3s ease;
        overflow: hidden;
      }
      
      .group-content.collapsed {
        max-height: 0;
        padding: 0;
      }
      
      .group-header {
        transition: background-color 0.3s ease;
      }
      
      .group-header:hover {
        background-color: var(--accent-color) !important;
      }
      
      .editable-cell {
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s ease;
        padding: 0 !important;
        /* min-width: 80px; */
        /* max-width: 200px; */
        box-sizing: border-box;
        overflow: hidden;
        height: 38px;
        line-height: 38px;
      }
      
      .editable-cell:hover {
        background-color: var(--accent-color) !important;
      }
      
      .editable-cell.editing {
        background-color: #fff3cd !important;
      }
      
      .edit-dropdown {
        width: 100%;
        box-sizing: border-box;
        padding: 0 8px;
        border: 1px solid var(--primary-color);
        border-radius: 4px;
        font-size: 0.9rem;
        background: #fff;
        height: 38px;
        line-height: 38px;
        margin: 0;
      }
      
      .edit-time {
        width: 100%;
        padding: 4px 8px;
        border: 1px solid var(--primary-color);
        border-radius: 4px;
        font-size: 0.9rem;
      }
      
      .period-filter {
        max-width: 200px;
      }
      
      .filter-active {
        background-color: var(--accent-color);
        border-color: var(--primary-color);
      }
      
      .table-white {
        background-color: #ffffff;
      }
      
      .table-light {
        background-color: #f8f9fa;
      }
      
      .table-light:hover {
        background-color: #e9ecef !important;
      }
      
      .table-white:hover {
        background-color: #f8f9fa !important;
      }
      


      @media (max-width: 768px) {
        #sidebar {
          margin-left: -240px;
        }
        #sidebar.toggled {
          margin-left: 0;
        }
        #sidebar-toggle {
          display: block;
          position: fixed;
          top: 15px;
          left: 15px;
          z-index: 1000;
        }
        .main-content {
          padding-top: 70px;
        }
        .module-stats {
          flex-direction: column;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <div class="sidebar" id="sidebar">
        <div class="logo">ADE UK</div>
        <ul class="nav flex-column p-3">
          <li class="nav-item">
            <a class="nav-link active" href="#">Module Planning</a>
          </li>
        </ul>
      </div>

      <div class="main-content">
        <button class="btn btn-secondary" id="sidebar-toggle">â˜°</button>
        <h1><i class="fas fa-calendar-alt"></i> Module Planning</h1>
        
        <div class="module-selector">
          <div class="row">
            <div class="col-md-6">
              <h5>Select Module:</h5>
              <div id="module-buttons"></div>
            </div>
            <div class="col-md-6">
              <h5>Filter by Period:</h5>
              <select id="period-filter" class="form-control" onchange="filterByPeriod()">
                <option value="">All Periods</option>
              </select>
            </div>
          </div>
          <button class="btn btn-outline-secondary btn-sm mt-2" onclick="debugConfiguration()">
            <i class="fas fa-bug"></i> Debug Configuration
          </button>
        </div>

        <div id="dropdown-data" style="display: none;">
          <!-- Dropdown data will be loaded here -->
        </div>

        <div id="loading" class="loading" style="display: none;">
          <i class="fas fa-spinner fa-spin fa-2x"></i>
          <p>Loading module data...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="module-content"></div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      document.getElementById('sidebar-toggle').addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('toggled');
      });

      // Load modules on page load
      document.addEventListener('DOMContentLoaded', function() {
        loadModules();
        loadDropdownData();
      });

      function loadModules() {
        showLoading();
        google.script.run
          .withSuccessHandler(function(response) {
            hideLoading();
            if (response && response.success) {
              displayModuleButtons(response.modules);
              // Show debug info if available
              if (response.debug) {
                console.log('Debug info:', response.debug);
                const container = document.getElementById('module-content');
                container.innerHTML = `
                  <div class="card">
                    <div class="card-header">
                      <h5><i class="fas fa-info-circle"></i> Data Processing Info</h5>
                    </div>
                    <div class="card-body">
                      <p><strong>Total rows:</strong> ${response.debug.totalRows}</p>
                      <p><strong>Non-empty rows:</strong> ${response.debug.nonEmptyRows}</p>
                      <p><strong>Unique modules found:</strong> ${response.debug.uniqueModulesCount || response.debug.uniqueModules.length}</p>
                      <p><strong>Modules:</strong> ${response.debug.uniqueModulesList ? response.debug.uniqueModulesList.join(', ') : response.debug.uniqueModules.join(', ')}</p>
                    </div>
                  </div>
                `;
              }
            } else {
              const errorMsg = response && response.error ? response.error : 'Unknown error occurred';
              showError('Failed to load modules: ' + errorMsg);
              if (response && response.stack) {
                console.error('Stack trace:', response.stack);
              }
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showError('Error loading modules: ' + (error.message || error));
          })
          .getUniqueModules();
      }

      function displayModuleButtons(modules) {
        const container = document.getElementById('module-buttons');
        container.innerHTML = '';
        
        modules.forEach(module => {
          const badge = document.createElement('span');
          badge.className = 'module-badge';
          badge.textContent = module;
          badge.onclick = () => loadModuleData(module);
          container.appendChild(badge);
        });
      }

      function loadModuleData(moduleName) {
        // Update active button
        document.querySelectorAll('.module-badge').forEach(badge => {
          badge.classList.remove('active');
        });
        event.target.classList.add('active');

        showLoading();
        google.script.run
          .withSuccessHandler(function(response) {
            hideLoading();
            if (response && response.success) {
              // Store current data for filtering
              currentModuleData = response.data;
              currentModuleName = moduleName;
              currentGroupedData = response.groupedData;
              currentGroups = response.groups;
              currentFilteredData = response.data;
              
              // Reset period filter
              document.getElementById('period-filter').value = '';
              
              displayModuleData(moduleName, response.data, response.groupedData, response.groups);
              // Show debug info if available
              if (response.debug) {
                console.log('Module data debug:', response.debug);
                const container = document.getElementById('module-content');
                const debugDiv = document.createElement('div');
                debugDiv.className = 'card mt-3';
                debugDiv.innerHTML = `
                  <div class="card-header">
                    <h6><i class="fas fa-bug"></i> Module Data Debug</h6>
                  </div>
                  <div class="card-body">
                    <p><strong>Requested module:</strong> ${response.debug.requestedModule}</p>
                    <p><strong>Total rows scanned:</strong> ${response.debug.totalRows}</p>
                    <p><strong>Matching rows found:</strong> ${response.debug.matchingRows}</p>
                    <p><strong>Total groups:</strong> ${response.debug.totalGroups || 'N/A'}</p>
                    <p><strong>Groups found:</strong> ${response.debug.groupsList ? response.debug.groupsList.join(', ') : 'N/A'}</p>
                    <p><strong>Sample data:</strong></p>
                    <pre>${JSON.stringify(response.debug.sampleData, null, 2)}</pre>
                  </div>
                `;
                container.appendChild(debugDiv);
              }
            } else {
              const errorMsg = response && response.error ? response.error : 'Unknown error occurred';
              showError('Failed to load module data: ' + errorMsg);
              if (response && response.stack) {
                console.error('Stack trace:', response.stack);
              }
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showError('Error loading module data: ' + (error.message || error));
          })
          .getModuleData(moduleName);
      }

      function renderWeekColoredRows(sessions) {
        let html = '';
        sessions.forEach(row => {
          html += `
            <tr style="background-color: #fff;">
              <td>${row[0] || '-'}</td>
              <td>${row[1] || '-'}</td>
              <td>${row[2] || '-'}</td>
              <td>${row[5] || '-'}</td>
              <td>${row[8] || '-'}</td>
              <td class="editable-cell" onclick="editCell(this, '${row[16] || ''}', 11, 'staff')" data-original="${row[11] || ''}">
                ${row[11] || '-'}
              </td>
              <td class="editable-cell" onclick="editCell(this, '${row[16] || ''}', 12, 'room')" data-original="${row[12] || ''}">
                ${row[12] || '-'}
              </td>
              <td class="editable-cell" onclick="editCell(this, '${row[16] || ''}', 13, 'day')" data-original="${row[13] || ''}">
                ${row[13] || '-'}
              </td>
              <td class="editable-cell" onclick="editCell(this, '${row[16] || ''}', 14, 'time')" data-original="${row[14] || ''}">
                ${row[14] || '-'}
              </td>
            </tr>
          `;
        });
        return html;
      }

      function displayModuleData(moduleName, data, groupedData, groups) {
        const container = document.getElementById('module-content');
        
        if (data.length === 0) {
          container.innerHTML = '<div class="alert alert-info">No data found for this module.</div>';
          return;
        }

        // Calculate statistics
        const totalHours = data.reduce((sum, row) => sum + (parseFloat(row[8]) || 0), 0);
        const uniqueTopics = [...new Set(data.map(row => row[5]).filter(topic => topic))];
        const uniqueLocations = [...new Set(data.map(row => row[6]).filter(location => location))];
        const uniqueStaff = [...new Set(data.map(row => row[11]).filter(staff => staff))];
        
        // Get discipline from first row (column D, index 3)
        const discipline = data[0] && data[0][3] ? data[0][3] : '';

        let html = `
          <div class="card module-card">
            <div class="module-header">
              <h3><i class="fas fa-book"></i> ${moduleName}</h3>
              ${discipline ? `<p class="mb-0"><i class="fas fa-graduation-cap"></i> ${discipline}</p>` : ''}
            </div>
            
            <div class="module-stats">
              <div class="stat-item">
                <div class="stat-value">${data.length}</div>
                <div class="stat-label">Sessions</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${totalHours}</div>
                <div class="stat-label">Total Hours</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${uniqueTopics.length}</div>
                <div class="stat-label">Topics</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">${groups ? groups.length : uniqueStaff.length}</div>
                <div class="stat-label">${groups ? 'Groups' : 'Staff'}</div>
              </div>
            </div>
          </div>
        `;

        // Add grouped sections
        if (groupedData && groups) {
          groups.forEach(group => {
            const groupSessions = groupedData[group];
            const groupHours = groupSessions.reduce((sum, row) => sum + (parseFloat(row[8]) || 0), 0);
            const groupId = `group-${group}`;
            const tableBody = renderWeekColoredRows(groupSessions);
            html += `
              <div class="card module-card mt-3">
                <div class="card-header bg-light group-header" style="cursor: pointer;" onclick="toggleGroup('${groupId}')">
                  <h5 class="mb-0 d-flex justify-content-between align-items-center">
                    <span>
                      <i class="fas fa-users"></i> Group: ${group}
                      <span class="badge badge-primary ml-2">${groupSessions.length} sessions</span>
                      <span class="badge badge-info ml-1">${groupHours} hours</span>
                    </span>
                    <i class="fas fa-chevron-down" id="icon-${groupId}"></i>
                  </h5>
                </div>
                <div class="card-body p-0 group-content" id="${groupId}">
                  <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0 timetable-table">
                      <thead class="thead-light">
                        <tr>
                          <th>Period</th>
                          <th>Week</th>
                          <th>Event Order</th>
                          <th>Topic</th>
                          <th>Hours</th>
                          <th>Staff</th>
                          <th>Room</th>
                          <th>Day</th>
                          <th>Time</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${tableBody}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            `;
          });
        } else {
          // Fallback to original table if no grouped data
          const tableBody = renderWeekColoredRows(data);
          html += `
            <div class="card module-card mt-3">
              <div class="card-body">
                <h5 class="card-title">Timetable Details</h5>
                <div class="table-responsive">
                  <table class="table table-striped timetable-table">
                    <thead>
                      <tr>
                        <th>Period</th>
                        <th>Week</th>
                        <th>Event Order</th>
                        <th>Topic</th>
                        <th>Groups</th>
                        <th>Hours</th>
                        <th>Staff</th>
                        <th>Room</th>
                        <th>Day</th>
                        <th>Time</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${tableBody}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          `;
        }
        
        container.innerHTML = html;
      }

      function showLoading() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('module-content').innerHTML = '';
        document.getElementById('error').style.display = 'none';
      }

      function hideLoading() {
        document.getElementById('loading').style.display = 'none';
      }

      function showError(message) {
        document.getElementById('error').textContent = message;
        document.getElementById('error').style.display = 'block';
        document.getElementById('module-content').innerHTML = '';
      }

      function toggleGroup(groupId) {
        const content = document.getElementById(groupId);
        const icon = document.getElementById(`icon-${groupId}`);
        
        if (content.classList.contains('collapsed')) {
          // Expand
          content.classList.remove('collapsed');
          icon.classList.remove('fa-chevron-right');
          icon.classList.add('fa-chevron-down');
        } else {
          // Collapse
          content.classList.add('collapsed');
          icon.classList.remove('fa-chevron-down');
          icon.classList.add('fa-chevron-right');
        }
      }

      // Global variables for dropdown data
      let staffList = [];
      let roomList = [];
      let periodList = [];
      let currentModuleData = null;
      let currentFilteredData = null;
      const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

      function loadDropdownData() {
        // Load staff list
        google.script.run
          .withSuccessHandler(function(response) {
            if (response && response.success) {
              staffList = response.staff;
            }
          })
          .getStaffList();

        // Load room list
        google.script.run
          .withSuccessHandler(function(response) {
            if (response && response.success) {
              roomList = response.rooms;
            }
          })
          .getRoomList();
          
        // Load period list
        google.script.run
          .withSuccessHandler(function(response) {
            if (response && response.success) {
              periodList = response.periods;
              populatePeriodFilter();
            }
          })
          .getUniquePeriods();
      }

      function editCell(cell, uid, columnIndex, fieldType) {
        const originalValue = cell.getAttribute('data-original') || '';
        const currentValue = cell.textContent.trim();
        
        // If already editing, don't do anything
        if (cell.classList.contains('editing')) return;
        
        // Check if UID is valid
        if (!uid || uid === '') {
          showError('Cannot edit: No UID found for this record');
          return;
        }
        
        cell.classList.add('editing');
        
        let inputElement;
        
        switch(fieldType) {
          case 'staff':
            inputElement = createDropdown(staffList, currentValue, 'edit-dropdown');
            break;
          case 'room':
            inputElement = createDropdown(roomList, currentValue, 'edit-dropdown');
            break;
          case 'day':
            inputElement = createDropdown(daysOfWeek, currentValue, 'edit-dropdown');
            break;
          case 'time':
            inputElement = createTimeInput(currentValue);
            break;
          default:
            return;
        }
        
        // Clear cell content and add input
        cell.innerHTML = '';
        cell.appendChild(inputElement);
        
        // Add blur event to save automatically
        inputElement.addEventListener('blur', () => {
          let newValue = inputElement.value;
          
          // Format time to HH:MM:SS if it's a time field
          if (fieldType === 'time' && newValue) {
            const timeParts = newValue.split(':');
            if (timeParts.length >= 2) {
              newValue = `${timeParts[0]}:${timeParts[1]}:00`;
            }
          }
          
          if (newValue !== originalValue) {
            saveCell(cell, uid, columnIndex, newValue);
          } else {
            cancelEdit(cell, originalValue);
          }
        });
        
        // Add enter key to save and escape key to cancel
        inputElement.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            let newValue = inputElement.value;
            
            // Format time to HH:MM:SS if it's a time field
            if (fieldType === 'time' && newValue) {
              const timeParts = newValue.split(':');
              if (timeParts.length >= 2) {
                newValue = `${timeParts[0]}:${timeParts[1]}:00`;
              }
            }
            
            saveCell(cell, uid, columnIndex, newValue);
          } else if (e.key === 'Escape') {
            cancelEdit(cell, originalValue);
          }
        });
        
        // Focus on input
        inputElement.focus();
      }

      function createDropdown(options, currentValue, className) {
        const select = document.createElement('select');
        select.className = className;
        
        // Remove the empty option for a better UX
        // Add options
        options.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option;
          optionElement.textContent = option;
          if (option === currentValue) {
            optionElement.selected = true;
          }
          select.appendChild(optionElement);
        });
        
        return select;
      }

      function createTimeInput(currentValue) {
        const input = document.createElement('input');
        input.type = 'time';
        input.className = 'edit-time';
        
        // Convert HH:MM:SS to HH:MM for the time input
        if (currentValue && currentValue.includes(':')) {
          const timeParts = currentValue.split(':');
          if (timeParts.length >= 2) {
            input.value = `${timeParts[0]}:${timeParts[1]}`;
          } else {
            input.value = currentValue;
          }
        } else {
          input.value = currentValue || '';
        }
        
        return input;
      }

      function saveCell(cell, uid, columnIndex, newValue) {
        google.script.run
          .withSuccessHandler(function(response) {
            if (response && response.success) {
              cell.textContent = newValue || '-';
              cell.setAttribute('data-original', newValue);
              cell.classList.remove('editing');
              // Show subtle success indicator
              cell.style.backgroundColor = '#d4edda';
              setTimeout(() => {
                cell.style.backgroundColor = '';
              }, 1000);
            } else {
              showError('Failed to save data: ' + (response.error || 'Unknown error'));
            }
          })
          .withFailureHandler(function(error) {
            showError('Error saving data: ' + error);
          })
          .saveEditedData(uid, columnIndex, newValue);
      }

      function cancelEdit(cell, originalValue) {
        cell.textContent = originalValue || '-';
        cell.classList.remove('editing');
      }

      function showSuccessMessage(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success alert-dismissible fade show';
        successDiv.style.position = 'fixed';
        successDiv.style.top = '20px';
        successDiv.style.right = '20px';
        successDiv.style.zIndex = '9999';
        successDiv.innerHTML = `
          ${message}
          <button type="button" class="close" onclick="this.parentElement.remove()">
            <span>&times;</span>
          </button>
        `;
        document.body.appendChild(successDiv);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
          if (successDiv.parentElement) {
            successDiv.remove();
          }
        }, 3000);
      }

      function populatePeriodFilter() {
        const filter = document.getElementById('period-filter');
        filter.innerHTML = '<option value="">All Periods</option>';
        
        periodList.forEach(period => {
          const option = document.createElement('option');
          option.value = period;
          option.textContent = period;
          filter.appendChild(option);
        });
      }

      function filterByPeriod() {
        const selectedPeriod = document.getElementById('period-filter').value;
        
        if (!currentModuleData) return;
        
        if (selectedPeriod === '') {
          // Show all data
          currentFilteredData = currentModuleData;
          displayModuleData(currentModuleName, currentModuleData, currentGroupedData, currentGroups);
        } else {
          // Filter by period
          currentFilteredData = currentModuleData.filter(row => row[0] === selectedPeriod);
          
          // Re-group the filtered data
          const filteredGroupedData = {};
          const filteredGroups = [];
          
          currentFilteredData.forEach(row => {
            const group = row[7] || 'No Group';
            if (!filteredGroupedData[group]) {
              filteredGroupedData[group] = [];
              filteredGroups.push(group);
            }
            filteredGroupedData[group].push(row);
          });
          
          // Sort groups numerically
          filteredGroups.sort((a, b) => {
            const numA = parseInt(a.toString().match(/\d+/)) || 0;
            const numB = parseInt(b.toString().match(/\d+/)) || 0;
            if (numA !== numB) return numA - numB;
            return a.toString().localeCompare(b.toString());
          });
          
          // Re-display the filtered data
          if (currentFilteredData.length > 0) {
            displayModuleData(currentModuleName, currentFilteredData, filteredGroupedData, filteredGroups);
          } else {
            document.getElementById('module-content').innerHTML = `
              <div class="alert alert-info">
                No sessions found for the selected period.
              </div>
            `;
          }
        }
      }

      function debugConfiguration() {
        showLoading();
        google.script.run
          .withSuccessHandler(function(response) {
            hideLoading();
            const container = document.getElementById('module-content');
            container.innerHTML = `
              <div class="card">
                <div class="card-header">
                  <h5><i class="fas fa-bug"></i> Debug Information</h5>
                </div>
                <div class="card-body">
                  <pre>${JSON.stringify(response, null, 2)}</pre>
                </div>
              </div>
            `;
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showError('Debug failed: ' + (error.message || error));
          })
          .debugConfig();
      }
    </script>
  </body>
</html> 